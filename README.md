# はじめに

GAS（Google Apps Script）を使用して公開されている Google カレンダーのカレンダーIDと Discord の Webhook URL を指定することで、以下のようなメッセージを Discord に送信できます。
このコードを GAS のトリガーを使用して数時間（4時間以内を推奨）ごとに実行することで、同じメッセージを編集する形で更新できます。Discord の新規メッセージ通知を煩わしく感じる方におすすめです。

![メッセージの例](https://github.com/murahito130/Google-Calendar-to-Discord-Notifier/blob/main/example.png)

### 注意

初期のコードは、制作者の生活サイクルを想定してプログラムされています。具体的には以下の通りです。

- 12時から18時を昼とする
- 20時から翌1時を夜とする
- 平日の日中（昼）は予定がある
- 土日祝日は予定が空いている

制作者と生活サイクルが異なる方や、設定の変更を希望される方は、ご自由にカスタマイズしてください。

# Google Calendar to Discord Notifier

このGoogle Apps Script（GAS）は、指定したGoogleカレンダーのイベント情報を定期的に取得し、その日の昼間と夜間の予定状況をDiscordのWebhook URLへ送信します。祝日や設定された出勤予定も考慮して、空き状況を分かりやすく表示します。

## 機能

- 複数のGoogleカレンダーを監視し、イベント情報を取得します。
- 日本の祝日カレンダー（または他の指定された休日カレンダー）の情報を取得し、祝日を考慮した判定を行います。
- 設定された出勤予定（曜日と時間帯）を考慮し、予定がない時間帯でも「予定あり」と判定できます。
- 昼間（設定された時間帯）と夜間（設定された時間帯）の予定状況を「◯」（空き）、「△」（要相談）、「✕」（予定あり）の記号で表示します。
- イベント間の指定された時間以上のギャップがある場合、予定ありの時間帯でも「△」と表示し、調整の余地があることを示唆します。
- 処理対象の月数（当月を含む前後数ヶ月）を設定可能です。
- DiscordのWebhook URLへ、各月の予定状況を埋め込み形式で送信します。
- メッセージの初回投稿後は、内容を編集して更新するため、チャンネルにスパムのような大量のメッセージを投稿しません。
- `@silent`フラグにより、Discord通知はサイレントに行われます。

## 設定

以下の定数はスクリプトの先頭部分で設定する必要があります。

- `CALENDAR_IDS`: 監視対象とするGoogleカレンダーのIDを配列で指定します。プライマリのメールアドレスや、共有カレンダーのIDを指定できます。
- `DISCORD_WEBHOOK_URL`: DiscordのWebhook URLを指定します。Webhookの設定方法は[Discord Developer Portal](https://discord.com/developers/docs/resources/webhook)を参照してください。
- `HOLIDAY_CALENDAR_IDS`: 祝日カレンダーのIDの配列です。日本の祝日カレンダーID `'ja.japanese#holiday@group.v.calendar.google.com'` がデフォルトで設定されています。必要に応じて他の国の祝日カレンダーIDを追加できます。
- `MESSAGE_ID_CACHE_KEY`: Discordに送信したメッセージのIDをキャッシュに保存するためのキーです。通常は変更する必要はありません。
- `NUM_OF_MONTHS`: 処理対象とする月数です。例えば `3` を指定すると、当月、翌月、翌々月の情報が送信されます。
- `WEEK_DAYS`: 曜日を表示するための配列です。通常は変更する必要はありません。
- `DAYTIME_START_HOUR`, `DAYTIME_END_HOUR`: 昼間の時間帯の開始時間と終了時間（時）を設定します。
- `NIGHTTIME_START_HOUR`, `NIGHTTIME_END_HOUR`: 夜間の時間帯の開始時間と終了時間（時）を設定します。終了時間が23を超える場合は、翌日の時間として扱われます（例：25は翌日1時）。
- `MIN_GAP_HOURS`: イベントとイベントの間、または時間帯の開始・終了とイベントの間に、この時間以上の空き時間がある場合、その時間帯のステータスを「△」とします。
- `PROCESSING_INTERVAL_MINUTES`: イベントの有無を判定する際の時間間隔（分）です。この間隔で区切ってイベントの存在を確認します。
- `WORK_SCHEDULES`: 休日・祝日ではない日に、予定が入っているとみなしたい時間帯を設定します。曜日（0:日, 1:月, ..., 6:土）、開始時間、終了時間を指定します。

## セットアップ

1. **Google Apps Scriptエディタを開く**:
   - Google Drive にアクセスし、「新規」>「その他」>「Google Apps Script」を選択します。
2. **コードをコピー＆ペースト**:
   - 提供された GAS のコード全体をコピーし、Apps Script エディタに貼り付けます。
3. **設定を編集**:
   - スクリプトの先頭にある設定 (`CALENDAR_IDS`, `DISCORD_WEBHOOK_URL` など) をご自身の環境に合わせて編集します。特に、`CALENDAR_IDS` と `DISCORD_WEBHOOK_URL` は必須の設定です。
4. **権限の承認**:
   - 初めてスクリプトを実行する際には、Google カレンダーへのアクセス許可を求められますので、承認してください。
5. **トリガーの設定 (推奨)**:
   - 定期的に自動で情報を送信するために、トリガーを設定します。
     - Apps Script エディタの左側にある時計のアイコン（トリガー）をクリックします。
     - 右下の「トリガーを追加」をクリックします。
     - 「実行する関数を選択」で `sendCalendarEventsToDiscord` を選択します。
     - 「イベントソースを選択」で「時間主導型」を選択します。
     - 「時間ベースのトリガーのタイプを選択」で、実行したい頻度（例: 「30分ごと」など）を選択します。
     - 必要に応じて他の設定を行い、「保存」をクリックします。

## 注意点

- スクリプトの実行には、Google カレンダーと外部サービス（Discord）へのアクセス許可が必要です。
- Webhook URL は機密情報ですので、安全に管理してください。
- スクリプトの動作頻度が高すぎると、Google Apps Script の制限に達する可能性がありますのでご注意ください。
- カレンダーのイベントの公開設定によっては、意図しない情報が Discord に送信される可能性があります。監視対象のカレンダーのイベント設定を確認してください。

このスクリプトを活用して、Google カレンダーの予定を Discord で簡単に共有し、チームやメンバー間の連携をスムーズにすることができます。
