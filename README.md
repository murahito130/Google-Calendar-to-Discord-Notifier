# Google Calendar to Discord Notifier

## はじめに

このツールは、Google Apps Script (GAS) を利用して、公開されている Google カレンダーの予定をDiscordへ通知するものです。指定したカレンダーIDとDiscordのWebhook URLを設定するだけで、日中の予定と夜間の予定の状況をDiscordに送信できます。

**主な特徴:**

- **定期的な自動更新:** GASのトリガー設定により、数時間おき（4時間以内推奨）にDiscordのメッセージを自動で更新します。Discordの通知スパムを避けたい方に最適です。
- **直感的なステータス表示:** 各時間帯の予定の有無を「◯」（空き）、「△」（要相談）、「✕」（予定あり）の記号で分かりやすく表示します。
- **祝日・出勤予定の考慮:** 日本の祝日カレンダーの情報や、設定した平日の出勤予定を考慮して、より正確な空き状況を通知します。
- **柔軟な時間設定:** 昼間と夜間の時間帯を自由に設定できます。
- **イベント間のギャップ通知:** イベント間に一定時間以上の空きがある場合、「△」と表示し、予定調整の可能性を示唆します。
- **複数月の対応:** 当月を含む前後数ヶ月の予定をまとめて通知できます。
- **埋め込み形式での送信:** Discordへのメッセージは埋め込み形式で送信され、見やすく整理されます。
- **サイレント通知:** `@silent`フラグにより、Discordの通知音を抑制できます。

**メッセージ例:**

![メッセージの例](https://github.com/murahito130/Google-Calendar-to-Discord-Notifier/blob/main/example.png)

**初期設定に関する注意:**

初期のコードは、開発者の生活パターンを基に設定されています。具体的には以下の点を考慮しています。

- **昼:** 12時から18時
- **夜:** 20時から翌1時
- **平日日中:** 予定あり（固定）
- **土日祝日:** 予定なし（固定）

ご自身の生活サイクルに合わせて、後述の設定項目をカスタマイズしてください。

## 機能詳細

- **複数カレンダー監視:** 複数のGoogleカレンダーIDを設定することで、複数のカレンダーのイベント情報をまとめて取得・表示できます。
- **祝日対応:** `HOLIDAY_CALENDAR_IDS` に日本の祝日カレンダーID（`'ja.japanese#holiday@group.v.calendar.google.com'`）がデフォルトで設定されており、祝日を自動的に考慮します。他の国の祝日カレンダーIDも追加可能です。
- **出勤予定:** `WORK_SCHEDULES` に曜日ごとの出勤時間帯を設定することで、たとえカレンダーに予定がなくても、その時間帯を「予定あり」と判定できます。
- **時間帯ステータス:** 設定された昼間と夜間の時間帯について、イベントの有無やイベント間のギャップに基づいて「◯」「△」「✕」のステータスを表示します。
- **ギャップ判定:** `MIN_GAP_HOURS` で設定した時間以上のイベント間の空き時間がある場合、予定ありの時間帯でも「△」（要相談）と表示します。
- **処理対象月:** `NUM_OF_MONTHS` で指定した月数（当月を含む）の予定情報を処理します。
- **曜日表示:** `WEEK_DAYS` 配列に基づいて、曜日を日本語で表示します。
- **Discordへの埋め込み送信:** 各月の予定状況は、Discordの埋め込み形式で分かりやすく送信されます。
- **メッセージ編集:** 初回投稿後、定期的に同じメッセージを編集して更新するため、Discordチャンネルがメッセージで溢れるのを防ぎます。
- **サイレント通知:** メッセージの送信時に `@silent` フラグを使用することで、Discordの通知音を抑制します。

## 設定項目

スクリプトの先頭部分にある以下の定数を、ご自身の環境に合わせて設定してください。

- **`CALENDAR_IDS`**: **必須** 監視したいGoogleカレンダーのIDを配列形式で指定します。
    - 例: `['your_primary_email@gmail.com', 'shared_calendar_id@group.calendar.google.com']`
- **`DISCORD_WEBHOOK_URL`**: **必須** DiscordのWebhook URLを指定します。
    - Webhookの設定方法は、[Discord Developer Portal](https://discord.com/developers/docs/resources/webhook) を参照してください。
- **`HOLIDAY_CALENDAR_IDS`**: 祝日カレンダーのIDの配列です。
    - デフォルト: `['ja.japanese#holiday@group.v.calendar.google.com']` (日本の祝日)
    - 他の国の祝日カレンダーを追加することも可能です。
- **`MESSAGE_ID_CACHE_KEY`**: Discordに送信したメッセージのIDをキャッシュに保存するためのキーです。通常は変更不要です。
    - デフォルト: `'DISCORD_CALENDAR_MESSAGE_ID'`
- **`NUM_OF_MONTHS`**: 処理対象とする月数です。
    - 例: `3` (当月、翌月、翌々月)
- **`WEEK_DAYS`**: 曜日を表示するための配列です。通常は変更不要です。
    - デフォルト: `['日', '月', '火', '水', '木', '金', '土']`
- **`DAYTIME_START_HOUR`**: 昼間の時間帯の開始時間（時）を整数で指定します。
    - 例: `12`
- **`DAYTIME_END_HOUR`**: 昼間の時間帯の終了時間（時）を整数で指定します。
    - 例: `18`
- **`NIGHTTIME_START_HOUR`**: 夜間の時間帯の開始時間（時）を整数で指定します。
    - 例: `20`
- **`NIGHTTIME_END_HOUR`**: 夜間の時間帯の終了時間（時）を整数で指定します。
    - 終了時間が23を超える場合は、翌日の時間として扱われます（例：翌1時なら `25`）。
    - 例: `25`
- **`MIN_GAP_HOURS`**: イベントとイベントの間、または時間帯の開始・終了とイベントの間に、この時間以上の空き時間がある場合に、その時間帯のステータスを「△」とします。
    - 例: `2` (2時間以上の空きがあれば「△」)
- **`PROCESSING_INTERVAL_MINUTES`**: イベントの有無を判定する際の時間間隔（分）です。この間隔で区切ってイベントの存在を確認します。
    - 例: `30` (30分ごとに予定の有無を確認)
- **`WORK_SCHEDULES`**: 休日・祝日ではない日に、予定が入っているとみなしたい時間帯を設定します。
    - 配列形式で、各要素は `{ day: 曜日 (0:日, 1:月, ..., 6:土), start: 開始時間 (時), end: 終了時間 (時) }` のオブジェクトです。
    - 例: `[{ day: 1, start: 9, end: 18 }, { day: 2, start: 9, end: 18 }, { day: 3, start: 9, end: 18 }, { day: 4, start: 9, end: 18 }, { day: 5, start: 9, end: 18 }]` (月曜日から金曜日の9時から18時)

## セットアップ手順

1. **Google Apps Scriptエディタを開く:**
   - Google Driveにアクセスし、「新規」 > 「その他」 > 「Google Apps Script」を選択します。
2. **コードの貼り付け:**
   - 提供されたGASのコードを全てコピーし、Apps Scriptエディタに貼り付けます。既存のコードは削除してください。
3. **設定の編集:**
   - スクリプト冒頭の `CALENDAR_IDS`、`DISCORD_WEBHOOK_URL` などの設定項目を、ご自身の環境に合わせて正確に編集してください。特に、カレンダーIDとWebhook URLの設定は必須です。
4. **権限の承認:**
   - 初めてスクリプトを実行する際、Googleカレンダーへのアクセス許可を求められます。「許可」をクリックして承認してください。
5. **トリガーの設定 (推奨):**
   - スクリプトを定期的に自動実行するために、トリガーを設定します。
     - Apps Scriptエディタ左側の時計アイコン（トリガー）をクリックします。
     - 右下の「トリガーを追加」ボタンをクリックします。
     - 「実行する関数を選択」で `sendCalendarEventsToDiscord` を選択します。
     - 「イベントソースを選択」で「時間主導型」を選択します。
     - 「時間ベースのトリガーのタイプを選択」で、実行頻度を選択します（例: 「30分ごと」、「1時間ごと」、「4時間ごと」など）。
     - 必要に応じて他の設定を行い、「保存」をクリックします。

## 利用上の注意点

- スクリプトの実行には、GoogleカレンダーとDiscordへのアクセス許可が必要です。
- Webhook URLは機密情報です。取り扱いには十分ご注意ください。
- スクリプトの実行頻度を高く設定しすぎると、Google Apps Scriptの実行制限に達する可能性があります。推奨の実行頻度（4時間以内ごと）を守ってください。
- 監視対象のGoogleカレンダーのイベント公開設定によっては、意図しない情報がDiscordに送信される可能性があります。イベントの公開設定を事前にご確認ください。

このスクリプトを活用することで、Googleカレンダーの予定をDiscordで簡単に共有し、チームやメンバー間の連携を円滑に進めることができます。
